# Supabase セットアップ手順

## SQLファイル一覧

1. **SETUP.sql** - 初期セットアップ用（最初に1回だけ実行）
2. **FIX_CONSTRAINTS.sql** - 設定保存の問題を修正（必ず実行してください）
3. **CHECK_DATABASE.sql** - データベースの状態を確認（オプション）

## 🚨 重要：設定が保存されない問題の修正

### 症状
- ユーザー名を入力して保存しても、リロードすると消える
- Claude APIキーを保存しても、反映されない
- 「保存しました」と表示されるが、実際には保存されていない

### 原因
`app_settings`テーブルにUNIQUE制約が設定されていないため、upsert（更新または挿入）が正しく動作していません。

### 解決方法

#### ステップ1: Supabase SQL Editorを開く
https://supabase.com/dashboard/ にアクセスして、プロジェクトを選択し、左メニューから「SQL Editor」を開きます。

#### ステップ2: FIX_CONSTRAINTS.sqlを実行
`supabase/FIX_CONSTRAINTS.sql` の内容を**全てコピー**して、SQL Editorに貼り付けて実行します。

このSQLは以下を実行します：
1. 既存の重複データを削除
2. UNIQUE制約を追加
3. インデックスを作成（パフォーマンス向上）
4. RLSポリシーを再作成
5. 結果を確認

#### ステップ3: 結果を確認
実行後、以下のような結果が表示されればOKです：
```
status: "FIX completed successfully! Settings can now be saved."
```

#### ステップ4: アプリケーションで動作確認
1. サーバーを再起動: `npm run dev`
2. 設定ページ（http://localhost:3000/settings）を開く
3. ユーザー名を入力して保存
4. **ページをリロード**
5. ユーザー名が残っていればOK！

---

## 📋 初回セットアップ（データベースが空の場合）

データベースを完全にリセットした場合は、以下の順番で実行してください：

### 1. SETUP.sql を実行
全てのテーブル、RLSポリシー、トリガーを作成します。

### 2. FIX_CONSTRAINTS.sql を実行
UNIQUE制約とインデックスを追加します。

### 3. CHECK_DATABASE.sql を実行（オプション）
データベースの状態を確認します。

---

## 🔍 トラブルシューティング

### それでも保存できない場合

#### 1. CHECK_DATABASE.sqlを実行して状態を確認
```sql
-- supabase/CHECK_DATABASE.sql の内容を実行
```

#### 2. 以下の項目をチェック
- ✅ `app_settings_key_user_id_key` という名前のUNIQUE制約が存在するか
- ✅ RLSポリシーが4つ（SELECT, INSERT, UPDATE, DELETE）存在するか
- ✅ RLSが有効（ENABLED）になっているか

#### 3. ブラウザのコンソールを確認
- F12キーを押して、Consoleタブを開く
- 保存ボタンを押した時にエラーが出ていないか確認
- エラーがある場合は、その内容をメモする

#### 4. サーバーのログを確認
- ターミナルでサーバーのログを確認
- エラーメッセージが出ていないか確認

---

## ✅ 動作確認チェックリスト

### 設定ページ
- [ ] ユーザー名を保存できる
- [ ] リロードしても名前が残る
- [ ] Claude APIキーを保存できる
- [ ] リロードしても「設定済み」と表示される

### ナレッジベース
- [ ] フォルダーを作成できる
- [ ] ドキュメントをアップロードできる
- [ ] フォルダー内にドキュメントが表示される

### チャット
- [ ] メッセージを送信できる
- [ ] AIが応答する
- [ ] ナレッジベースの内容を参照した回答が返る

---

## 📞 サポート

上記の手順で解決しない場合は、以下の情報を提供してください：
1. CHECK_DATABASE.sqlの実行結果
2. ブラウザコンソールのエラーメッセージ
3. サーバーログのエラーメッセージ
