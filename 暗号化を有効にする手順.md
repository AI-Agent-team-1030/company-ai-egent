# 🔐 APIキー暗号化を有効にする手順

## 完了しました！

暗号化機能を実装しました：
- ✅ AES-256-CBC方式で暗号化
- ✅ APIキー、シークレット、パスワード、トークンなどを自動検出
- ✅ 保存時に自動で暗号化、取得時に自動で復号化
- ✅ チャットAPIでも復号化対応

## 今すぐやること（1分）

### ステップ1: APIキーを再保存

1. **http://localhost:3000/settings** を開く
2. 「APIキー」の欄を**クリアして再入力**（または同じ値をコピペ）
3. 「APIキーを保存」をクリック
4. 「保存しました」と表示されることを確認

これで、Supabaseに**暗号化されたAPIキー**が保存されます！

### ステップ2: Supabaseで確認

1. https://supabase.com/dashboard/ を開く
2. Table Editor → `app_settings` を開く
3. `anthropic_api_key` のレコードを確認
4. `value` カラムに**ランダムな文字列**が表示されていればOK！

**正しく暗号化された例：**
```
a1b2c3d4e5f6g7h8:9i0j1k2l3m4n5o6p...
```

**暗号化されていない例（NG）：**
```
sk-ant-api03-HfE2S7Fbf_IJBKFV...
```

### ステップ3: チャットで動作確認

1. http://localhost:3000/chat を開く
2. メッセージを送信
3. 正常に応答が返ればOK！

---

## 仕組み

### 保存時
```
ユーザーがAPIキーを入力
   ↓
APIがセンシティブなキーかどうか判定
   ↓
暗号化してSupabaseに保存
```

### 取得時
```
Supabaseから暗号化されたデータを取得
   ↓
APIが自動で復号化
   ↓
アプリケーションで使用
```

---

## センシティブなキーの判定

以下のキーワードを含む設定は自動で暗号化されます：
- `api_key`
- `secret`
- `password`
- `token`
- `anthropic_api_key`
- `openai_api_key`

例：
- ✅ `anthropic_api_key` → 暗号化される
- ✅ `database_password` → 暗号化される
- ✅ `jwt_secret` → 暗号化される
- ❌ `user_name` → 暗号化されない
- ❌ `theme` → 暗号化されない

---

## セキュリティの向上点

### 以前：
- ❌ APIキーが平文でSupabaseに保存
- ❌ データベースを見れば誰でもAPIキーが見える
- ❌ SQLインジェクション等でAPIキーが漏洩するリスク

### 現在：
- ✅ APIキーが暗号化されてSupabaseに保存
- ✅ データベースを見ても暗号化された文字列しか見えない
- ✅ 暗号化キーを知らなければ復号化できない
- ✅ アプリケーション側でのみ復号化可能

---

## 完了チェックリスト

- [ ] 設定ページでAPIキーを再保存した
- [ ] Supabaseで`app_settings`テーブルを確認した
- [ ] `anthropic_api_key`の`value`がランダムな文字列になっている
- [ ] チャットでメッセージを送信できる
- [ ] AIが正常に応答する

すべてにチェックが入れば完了です！🎉

---

## トラブルシューティング

### APIキーを再保存したのに平文のまま

**原因：** ブラウザのキャッシュが原因の可能性があります。

**解決：**
1. ブラウザでF5キーを押して強制リロード（Ctrl+Shift+R / Cmd+Shift+R）
2. APIキーを再度保存してみる

### チャットでエラーが出る

**エラー：** 「Claude APIキーが設定されていません」

**解決：**
1. 設定ページでAPIキーが「設定済み」と表示されているか確認
2. 表示されていなければ、APIキーを再入力して保存
3. ブラウザコンソール（F12）でエラーログを確認

---

## 暗号化キーの管理

現在はデフォルトの暗号化キーを使用していますが、本番環境では`.env`ファイルに独自のキーを設定してください：

```bash
# .env
ENCRYPTION_KEY=your-32-character-secret-key-here!!
```

**重要：**
- 暗号化キーは32文字にしてください
- 暗号化キーを変更すると、既存の暗号化データが復号化できなくなります
- 暗号化キーは絶対に公開しないでください
