# マルチテナント機能セットアップガイド

**Version 2.0 対応**
**最終更新**: 2025年11月24日

---

## 🎯 この機能について

企業ごとにデータを分離し、同じ企業のユーザー間でナレッジを共有できるようになります。

### 変更点
- **登録**: 企業名 + お名前 + メールアドレス + パスワード
- **ログイン**: 企業名 + メールアドレス + パスワード
- **ナレッジ共有**: 同じ企業名で登録したユーザー間で自動共有

---

## 📋 セットアップ手順

### Step 1: Supabaseマイグレーションを実行

1. **Supabaseダッシュボードにアクセス**
   https://supabase.com/dashboard

2. **プロジェクトを選択**

3. **SQL Editorを開く**
   左メニュー → SQL Editor

4. **新しいクエリを作成**
   「New query」ボタンをクリック

5. **マイグレーションSQLを貼り付け**
   `supabase/migrations/20250124000000_add_multi_tenant.sql` の内容を全てコピーして貼り付け

6. **実行**
   右下の「Run」ボタンをクリック

7. **成功確認**
   エラーが出なければ成功！

---

## ✅ 動作確認

### 1. 新規登録テスト

1. http://localhost:3002/auth/signup にアクセス

2. 以下を入力:
   - 企業名: `テスト株式会社`
   - お名前: `山田太郎`
   - メールアドレス: `test@example.com`
   - パスワード: `password123`

3. 登録ボタンをクリック

4. チャットページにリダイレクトされれば成功！

### 2. ナレッジ共有テスト

1. **ユーザー1**: ナレッジを作成
2. **ユーザー2**: 同じ企業名で別のメールアドレスで登録
3. **ユーザー2**: ナレッジ一覧を確認 → ユーザー1が作成したナレッジが見えればOK

### 3. 企業分離テスト

1. **ユーザー3**: 別の企業名で登録
2. **ユーザー3**: ナレッジ一覧を確認 → ユーザー1・2のナレッジが見えなければOK

---

## 🔧 トラブルシューティング

### マイグレーション実行時にエラーが出る

**症状**: `relation "companies" already exists`

**原因**: 既にテーブルが存在している

**解決方法**:
```sql
-- 既存のテーブルを削除（注意: データが消えます）
DROP TABLE IF EXISTS profiles CASCADE;
DROP TABLE IF EXISTS companies CASCADE;

-- その後、再度マイグレーションを実行
```

---

### ログイン時に「企業が見つかりません」エラー

**原因**: 企業名の入力が登録時と異なる

**解決方法**:
- 登録時と全く同じ企業名を入力してください
- 「株式会社」「(株)」などは自動で正規化されます
  - `ABC株式会社` = `ABC(株)` = `ABC` すべて同じ企業として認識

---

### ナレッジが共有されない

**症状**: 同じ企業のユーザーなのにナレッジが見えない

**確認事項**:
1. RLSポリシーが正しく設定されているか確認
```sql
SELECT * FROM pg_policies WHERE tablename = 'knowledge_items';
```

2. プロフィールが正しく作成されているか確認
```sql
SELECT * FROM profiles;
```

3. ナレッジに company_id が設定されているか確認
```sql
SELECT id, title, company_id FROM knowledge_items;
```

---

## 📊 データベース構造

### companies テーブル
```sql
id UUID              -- 企業ID
name TEXT            -- 表示用企業名（例: ABC株式会社）
normalized_name TEXT -- 正規化された企業名（検索用: abc）
```

### profiles テーブル
```sql
id UUID         -- ユーザーID（auth.usersと紐付け）
company_id UUID -- 企業ID
user_name TEXT  -- ユーザー名
department TEXT -- 部署（将来の拡張用）
```

### knowledge_items（既存テーブルに追加）
```sql
company_id UUID -- 企業ID（新規追加）
```

---

## 🚀 次のステップ

### すぐにできること
1. ナレッジベースでフォルダーを企業ごとに分ける
2. チャット履歴を企業ごとに分離
3. サイドバーに企業名を表示

### 将来の拡張
1. 部署機能の追加
2. 管理者画面の作成
3. 企業間のナレッジ共有設定

---

## 💡 よくある質問

### Q: 既存ユーザーのデータはどうなる？

A: マイグレーション実行後、既存ユーザーは次回ログイン時に企業名の入力が必要になります。その際に自動的にプロフィールが作成されます。

### Q: 企業名を変更できる？

A: 現在はSupabaseダッシュボードから手動で変更してください。将来的に管理画面で変更できるようにする予定です。

### Q: Gmail等の個人メールアドレスは使える？

A: はい、使えます！企業名で分離するので、メールアドレスのドメインは関係ありません。

---

**セットアップ完了したら、テストしてみてください！**
