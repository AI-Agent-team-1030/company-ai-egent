# ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®Œå…¨ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ä»Šã¾ã§ã«ç™ºç”Ÿã—ãŸå…¨ã¦ã®å•é¡Œã¨è§£æ±ºæ–¹æ³•ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚
**åŒã˜ãƒŸã‚¹ã‚’ç¹°ã‚Šè¿”ã•ãªã„ãŸã‚ã«ã€å¿…ãšå‚ç…§ã—ã¦ãã ã•ã„ã€‚**

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ã®å•é¡Œ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ã®å•é¡Œ)
2. [APIèªè¨¼ã®å•é¡Œ](#apièªè¨¼ã®å•é¡Œ)
3. [ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å•é¡Œ](#ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å•é¡Œ)
4. [è¨­å®šä¿å­˜ã®å•é¡Œ](#è¨­å®šä¿å­˜ã®å•é¡Œ)
5. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œ](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œ)
6. [ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã®å•é¡Œ](#ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã®å•é¡Œ)

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ã®å•é¡Œ

### âŒ å•é¡Œ1: è¨­å®šãŒä¿å­˜ã•ã‚Œãªã„

**ç—‡çŠ¶ï¼š**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ã€Œä¿å­˜ã€ã‚’æŠ¼ã—ã¦ã‚‚ã€ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ¶ˆãˆã‚‹
- Claude APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ã‚‚åæ˜ ã•ã‚Œãªã„
- ã€Œä¿å­˜ã—ã¾ã—ãŸã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ãŒã€å®Ÿéš›ã«ã¯ä¿å­˜ã•ã‚Œã¦ã„ãªã„

**åŸå› ï¼š**
1. `app_settings`ãƒ†ãƒ¼ãƒ–ãƒ«ã«UNIQUEåˆ¶ç´„ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
2. é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ï¼ˆåŒã˜key, user_idã®çµ„ã¿åˆã‚ã›ãŒè¤‡æ•°ã‚ã‚‹ï¼‰
3. upsertæ“ä½œãŒUNIQUEåˆ¶ç´„ã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€åˆ¶ç´„ãŒãªã„ã¨æ­£ã—ãå‹•ä½œã—ãªã„

**è§£æ±ºæ–¹æ³•ï¼š**

1. **Supabaseã§ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œ:**
```sql
-- é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
DELETE FROM app_settings
WHERE id IN (
  SELECT id
  FROM (
    SELECT id,
           ROW_NUMBER() OVER (PARTITION BY key, user_id ORDER BY updated_at DESC) as rn
    FROM app_settings
  ) t
  WHERE rn > 1
);

-- UNIQUEåˆ¶ç´„ã‚’è¿½åŠ 
ALTER TABLE app_settings DROP CONSTRAINT IF EXISTS app_settings_key_user_id_key;
ALTER TABLE app_settings ADD CONSTRAINT app_settings_key_user_id_key UNIQUE (key, user_id);
```

2. **APIã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£:**
```typescript
// âŒ ãƒ€ãƒ¡ãªä¾‹: upsertã ã‘ã«ä¾å­˜
const { data, error } = await supabase
  .from('app_settings')
  .upsert({ key, value, user_id })
  .select()
  .single()

// âœ… è‰¯ã„ä¾‹: æ—¢å­˜ãƒã‚§ãƒƒã‚¯â†’UPDATE or INSERT
const { data: existing } = await supabase
  .from('app_settings')
  .select('id')
  .eq('key', key)
  .eq('user_id', user.id)
  .maybeSingle()

if (existing) {
  // UPDATE
  await supabase
    .from('app_settings')
    .update({ value })
    .eq('id', existing.id)
} else {
  // INSERT
  await supabase
    .from('app_settings')
    .insert({ key, value, user_id })
}
```

**äºˆé˜²ç­–ï¼š**
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ™‚ã«å¿…ãšUNIQUEåˆ¶ç´„ã‚’è¨­å®šã™ã‚‹
- âœ… upsertã‚’ä½¿ã†å ´åˆã¯ã€onConflictã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹
- âœ… æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰INSERT/UPDATEã‚’ä½¿ã„åˆ†ã‘ã‚‹

---

### âŒ å•é¡Œ2: ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„ï¼ˆé‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰

**ç—‡çŠ¶ï¼š**
- ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã«ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è¡¨ç¤ºã•ã‚Œãªã„
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹

**åŸå› ï¼š**
- é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€`.single()`ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹

**è§£æ±ºæ–¹æ³•ï¼š**

```typescript
// âŒ ãƒ€ãƒ¡ãªä¾‹: é‡è¤‡ãŒã‚ã‚‹ã¨ã‚¨ãƒ©ãƒ¼
const { data } = await supabase
  .from('app_settings')
  .select('*')
  .eq('key', key)
  .single()  // è¤‡æ•°ã‚ã‚‹ã¨ã‚¨ãƒ©ãƒ¼

// âœ… è‰¯ã„ä¾‹: æœ€æ–°ã®ã‚‚ã®ã‚’å–å¾—
const { data } = await supabase
  .from('app_settings')
  .select('*')
  .eq('key', key)
  .eq('user_id', user.id)
  .order('updated_at', { ascending: false })
  .limit(1)
  .maybeSingle()  // 0ä»¶ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„
```

**äºˆé˜²ç­–ï¼š**
- âœ… `.single()`ã®ä»£ã‚ã‚Šã«`.limit(1).maybeSingle()`ã‚’ä½¿ã†
- âœ… ORDER BYã§æœ€æ–°ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹
- âœ… user_idã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹

---

### âŒ å•é¡Œ3: ORDER BYã®ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„

**ç—‡çŠ¶ï¼š**
- `column "created_at" does not exist`
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› ï¼š**
- ãƒ†ãƒ¼ãƒ–ãƒ«ã«`created_at`ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„ã®ã«ã€ORDER BYã§æŒ‡å®šã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•ï¼š**

```typescript
// âŒ ãƒ€ãƒ¡ãªä¾‹: å­˜åœ¨ã—ãªã„ã‚«ãƒ©ãƒ 
.order('created_at', { ascending: false })

// âœ… è‰¯ã„ä¾‹: å­˜åœ¨ã™ã‚‹ã‚«ãƒ©ãƒ 
.order('id', { ascending: false })
// ã¾ãŸã¯
.order('updated_at', { ascending: false })
```

**äºˆé˜²ç­–ï¼š**
- âœ… ORDER BYã‚’ä½¿ã†å‰ã«ã€ã‚«ãƒ©ãƒ ã®å­˜åœ¨ã‚’ç¢ºèªã™ã‚‹
- âœ… Supabaseã®ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’ç¢ºèªã™ã‚‹
- âœ… idã‚’ä½¿ãˆã°ç¢ºå®Ÿï¼ˆå¿…ãšå­˜åœ¨ã™ã‚‹ï¼‰

---

## APIèªè¨¼ã®å•é¡Œ

### âŒ å•é¡Œ4: RLS Policyé•åã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶ï¼š**
- `new row violates row-level security policy`
- APIå‘¼ã³å‡ºã—ã§500ã‚¨ãƒ©ãƒ¼
- ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ãƒ»å–å¾—ã§ããªã„

**åŸå› ï¼š**
- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ã„ãªã„
- RLSãƒãƒªã‚·ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥ã§ããªã„

**è§£æ±ºæ–¹æ³•ï¼š**

```typescript
// âŒ ãƒ€ãƒ¡ãªä¾‹: ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ã®ã¿
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

// âœ… è‰¯ã„ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
const authHeader = request.headers.get('Authorization')
const token = authHeader.replace('Bearer ', '')

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
  {
    global: {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    },
  }
)

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ç¢ºèª
const { data: { user } } = await supabase.auth.getUser()
if (!user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}
```

**äºˆé˜²ç­–ï¼š**
- âœ… ã™ã¹ã¦ã®API Routeã§Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
- âœ… èªè¨¼æ¸ˆã¿Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
- âœ… user.idã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»å–å¾—ã™ã‚‹

---

## ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å•é¡Œ

### âŒ å•é¡Œ5: ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ãŸã®ã«åæ˜ ã•ã‚Œãªã„

**ç—‡çŠ¶ï¼š**
- ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ãŸã®ã«ã€å¤ã„ã‚¨ãƒ©ãƒ¼ãŒå‡ºç¶šã‘ã‚‹
- ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ãŒä¿®æ­£ã•ã‚Œãªã„
- å¥‡å¦™ãªæŒ™å‹•ãŒç¶šã

**åŸå› ï¼š**
- Next.jsã®`.next`ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ®‹ã£ã¦ã„ã‚‹
- å¤ã„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ã‚³ãƒ¼ãƒ‰ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•ï¼š**

```bash
# 1. ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ï¼ˆCtrl+Cï¼‰

# 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
cd "/Users/kurosakiyuto/æ³•äººAIç´ æ¡ˆ"
rm -rf .next

# 3. ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•
npm run dev
```

**äºˆé˜²ç­–ï¼š**
- âœ… ãŠã‹ã—ãªæŒ™å‹•ãŒç¶šãå ´åˆã¯ã€ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
- âœ… å¤§ããªå¤‰æ›´ã‚’ã—ãŸå¾Œã¯ã€å¿µã®ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
- âœ… ã‚¨ãƒ©ãƒ¼ãŒç›´ã‚‰ãªã„å ´åˆã¯ã€å¿…ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢

---

## è¨­å®šä¿å­˜ã®å•é¡Œ

### âŒ å•é¡Œ6: ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å…¥åŠ›ã—ãŸå†…å®¹ãŒæ¶ˆãˆã‚‹

**ç—‡çŠ¶ï¼š**
- ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å…¥åŠ›
- ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
- å…¥åŠ›ã—ãŸå†…å®¹ãŒå³åº§ã«æ¶ˆãˆã‚‹

**åŸå› ï¼š**
- ä¿å­˜å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦ã„ãªã„
- ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹ãŒä¿å­˜å‰ã®çŠ¶æ…‹ã«æˆ»ã£ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•ï¼š**

```typescript
// âŒ ãƒ€ãƒ¡ãªä¾‹: ä¿å­˜å¾Œã«ä½•ã‚‚ã—ãªã„
const handleSave = async () => {
  const response = await apiPost('/api/settings', { key, value })
  if (response.ok) {
    setShowSuccess(true)
  }
}

// âœ… è‰¯ã„ä¾‹: ä¿å­˜å¾Œã«å†å–å¾—
const handleSave = async () => {
  const response = await apiPost('/api/settings', { key, value })
  if (response.ok) {
    setShowSuccess(true)
    // ä¿å­˜å¾Œã«å†å–å¾—ã—ã¦ç”»é¢ã‚’æ›´æ–°
    await fetchSettings()
  }
}
```

**äºˆé˜²ç­–ï¼š**
- âœ… ä¿å­˜å¾Œã¯å¿…ãšãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã™ã‚‹
- âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥stateã«ã‚»ãƒƒãƒˆã™ã‚‹
- âœ… ãƒ­ã‚°ã§ä¿å­˜ãƒ»å–å¾—ã®æµã‚Œã‚’ç¢ºèªã™ã‚‹

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œ

### âŒ å•é¡Œ7: APIã‚­ãƒ¼ãŒå¹³æ–‡ã§Supabaseã«ä¿å­˜ã•ã‚Œã‚‹

**ç—‡çŠ¶ï¼š**
- Supabaseã®Table Editorã§`app_settings`ã‚’é–‹ãã¨ã€APIã‚­ãƒ¼ãŒä¸¸è¦‹ãˆ
- `sk-ant-api03-...`ã¨ã„ã†æ–‡å­—åˆ—ãŒè¦‹ãˆã‚‹

**åŸå› ï¼š**
- APIã‚­ãƒ¼ã‚’æš—å·åŒ–ã›ãšã«ãã®ã¾ã¾ä¿å­˜ã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•ï¼š**

1. **æš—å·åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œæˆ** (`lib/encryption.ts`)
```typescript
import crypto from 'crypto'

export function encrypt(text: string): string {
  const iv = crypto.randomBytes(16)
  const cipher = crypto.createCipheriv('aes-256-cbc', getKey(), iv)
  let encrypted = cipher.update(text, 'utf8', 'hex')
  encrypted += cipher.final('hex')
  return iv.toString('hex') + ':' + encrypted
}

export function decrypt(text: string): string {
  const parts = text.split(':')
  const iv = Buffer.from(parts[0], 'hex')
  const decipher = crypto.createDecipheriv('aes-256-cbc', getKey(), iv)
  let decrypted = decipher.update(parts[1], 'hex', 'utf8')
  decrypted += decipher.final('utf8')
  return decrypted
}

export function isSensitiveKey(key: string): boolean {
  return key.includes('api_key') || key.includes('secret') ||
         key.includes('password') || key.includes('token')
}
```

2. **APIã§ä½¿ç”¨:**
```typescript
// ä¿å­˜æ™‚
if (isSensitiveKey(key)) {
  valueToSave = encrypt(value)
}

// å–å¾—æ™‚
if (isSensitiveKey(key)) {
  data.value = decrypt(data.value)
}
```

**äºˆé˜²ç­–ï¼š**
- âœ… ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒ¼ã‚¿ã¯å¿…ãšæš—å·åŒ–ã™ã‚‹
- âœ… æš—å·åŒ–ã‚­ãƒ¼ã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã™ã‚‹
- âœ… ãƒ­ã‚°ã«å¹³æ–‡ã®APIã‚­ãƒ¼ã‚’å‡ºåŠ›ã—ãªã„

---

## ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã®å•é¡Œ

### âŒ å•é¡Œ8: ãƒãƒ¼ãƒˆ3000ãŒä½¿ãˆãªã„

**ç—‡çŠ¶ï¼š**
- ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã¨`Port 3000 is in use, trying 3001 instead.`
- ãƒãƒ¼ãƒˆ3001ã€3002ã¨å¢—ãˆã¦ã„ã
- è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ãŒåŒæ™‚ã«å‹•ã„ã¦ã„ã‚‹

**åŸå› ï¼š**
- ä»¥å‰èµ·å‹•ã—ãŸã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã—ã¦ã„ãªã„
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§next-serverãƒ—ãƒ­ã‚»ã‚¹ãŒæ®‹ã£ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•ï¼š**

```bash
# ã™ã¹ã¦ã®Next.jsãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
pkill -9 -f "npm run dev"
pkill -9 -f "node.*next"

# ç¢ºèª
ps aux | grep next | grep -v grep

# èµ·å‹•
npm run dev
```

**äºˆé˜²ç­–ï¼š**
- âœ… ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹å‰ã«ã€æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèªã™ã‚‹
- âœ… Ctrl+Cã§ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹ç¿’æ…£ã‚’ã¤ã‘ã‚‹
- âœ… ãŠã‹ã—ããªã£ãŸã‚‰ã€ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’killã™ã‚‹

---

## âœ… ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

1. **UNIQUEåˆ¶ç´„ã‚’å¿…ãšè¨­å®šã™ã‚‹**
```sql
UNIQUE(key, user_id)
```

2. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹**
```sql
CREATE INDEX idx_app_settings_user_id ON app_settings(user_id);
```

3. **RLSãƒãƒªã‚·ãƒ¼ã‚’æ­£ã—ãè¨­å®šã™ã‚‹**
```sql
CREATE POLICY "Users can view their own settings"
ON app_settings FOR SELECT
USING (auth.uid() = user_id);
```

### APIè¨­è¨ˆ

1. **èªè¨¼æ¸ˆã¿ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã†**
```typescript
const supabase = createClient(url, key, {
  global: { headers: { Authorization: `Bearer ${token}` } }
})
```

2. **ãƒ­ã‚°ã‚’è¿½åŠ ã™ã‚‹**
```typescript
console.log(`[API] Saving: key=${key}, user_id=${user.id}`)
```

3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¾¹åº•ã™ã‚‹**
```typescript
try {
  // å‡¦ç†
} catch (error) {
  console.error('[API] Error:', error)
  return NextResponse.json({ error: error.message }, { status: 500 })
}
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

1. **ä¿å­˜å¾Œã«å†å–å¾—**
```typescript
await apiPost('/api/settings', { key, value })
await fetchSettings()  // å¿…é ˆ
```

2. **ãƒ­ã‚°ã‚’æ´»ç”¨**
```typescript
console.log('[Page] Saving...', { key, value })
console.log('[Page] Saved successfully')
```

3. **ã‚¨ãƒ©ãƒ¼ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º**
```typescript
if (!response.ok) {
  const error = await response.json()
  alert(`ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.error}`)
}
```

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°ã®æ‰‹é †

å•é¡ŒãŒèµ·ããŸã‚‰ã€ä»¥ä¸‹ã®é †ç•ªã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š

### 1. ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª
- F12ã‚­ãƒ¼ã‚’æŠ¼ã™
- Consoleã‚¿ãƒ–ã‚’é–‹ã
- èµ¤ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

### 2. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèª
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™

### 3. Supabaseã§ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
- Table Editorã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–‹ã
- ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„ã‹ç¢ºèª

### 4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
```bash
rm -rf .next
npm run dev
```

### 5. ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•
```bash
# Ctrl+C ã§åœæ­¢
pkill -9 -f "npm run dev"
npm run dev
```

---

## ğŸ“ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

æ–°æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã¨ãã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- [ ] UNIQUEåˆ¶ç´„ã¯è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] RLSãƒãƒªã‚·ãƒ¼ã¯æ­£ã—ã„ã‹
- [ ] ã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã™ã‚‹ã‹

### API
- [ ] èªè¨¼æ¸ˆã¿ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã„ã‚‹ã‹
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ã—ã¦ã„ã‚‹ã‹
- [ ] ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã‹

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- [ ] ä¿å­˜å¾Œã«å†å–å¾—ã—ã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹
- [ ] ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã‹

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒ¼ã‚¿ã¯æš—å·åŒ–ã—ã¦ã„ã‚‹ã‹
- [ ] APIã‚­ãƒ¼ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦ã„ãªã„ã‹

---

## ğŸ†˜ å›°ã£ãŸã¨ãã¯

1. ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹
2. ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹
3. Supabaseã§ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹
4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
5. ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã™ã‚‹

**ãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ãƒ¢ã—ã¦ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚**

---

æœ€çµ‚æ›´æ–°: 2025-11-21
