# 🎉 セットアップガイド（最終版）

## ✅ 完了したこと

1. **SQLエラー修正** - VECTOR型を削除してシンプルなテキスト検索に
2. **Claudeモデル更新** - `claude-3-7-sonnet-20250219` （最新）に変更
3. **ナレッジページ刷新** - ドキュメントアップロード機能を追加
4. **RAG機能実装** - アップロードしたドキュメントをAIが参照

---

## 🚀 次にやること（2ステップのみ！）

### ステップ1: SQLを実行

1. Supabase SQL Editorを開く
2. 以下のファイルの内容を実行:
   ```
   supabase/migrations/002_add_document_upload.sql
   ```

**実行内容:**
- ✅ 既存のナレッジデータを削除
- ✅ `uploaded_documents` テーブル作成
- ✅ `document_chunks` テーブル作成（テキスト検索用）

---

### ステップ2: Supabase Storageバケットを作成

1. Supabase Dashboard → Storage を開く
2. 「New bucket」をクリック
3. 以下の設定で作成:
   - **Name**: `documents`
   - **Public**: ❌ OFF（プライベート）
   - **File size limit**: 50MB

---

## 🎨 新しい機能

### 1. ナレッジページ (`/knowledge`)
- **ファイルアップロード**
  - PDF、テキスト、Markdown、Word対応
  - 最大50MB
- **自動テキスト抽出**
  - バックグラウンドで処理
  - チャンク分割（2000文字ごと）
- **ドキュメント管理**
  - 一覧表示
  - 削除機能
  - 処理状態の表示

### 2. チャットページ (`/chat`)
- **RAG (Retrieval Augmented Generation)**
  - 質問に関連するドキュメントを自動検索
  - ドキュメントの内容を参照してClaude AIが回答
  - 参照したドキュメント名を表示
- **最新Claudeモデル**
  - `claude-3-7-sonnet-20250219` 使用
  - max_tokens: 8192

---

## 📦 使い方

### 1. Claude APIキーを設定（まだの場合）

1. http://localhost:3000/settings
2. Claude APIキーを入力・保存

### 2. ドキュメントをアップロード

1. http://localhost:3000/knowledge
2. 「ドキュメント追加」ボタンをクリック
3. PDF、テキスト、Markdown、Wordファイルを選択
4. アップロード完了後、数秒で「処理済み」に変わる

### 3. チャットで質問

1. http://localhost:3000/chat
2. アップロードしたドキュメントに関する質問をする
3. AIが自動的にドキュメントを検索して回答

---

## 🔧 技術詳細

### テキスト検索の仕組み

1. **アップロード時**
   - ファイルからテキストを抽出
   - 2000文字ごとにチャンク分割
   - `document_chunks`テーブルに保存

2. **検索時**
   - ユーザーの質問をクエリとして使用
   - PostgreSQLの全文検索（`textSearch`）で関連チャンクを取得
   - 上位5件のチャンクをClaude APIに渡す

3. **回答生成**
   - Claudeが関連ドキュメントを参照
   - コンテキストを考慮した回答を生成

---

## 🎯 対応ファイル形式

- ✅ PDF (`.pdf`) - `pdf-parse`で抽出
- ✅ テキスト (`.txt`)
- ✅ Markdown (`.md`)
- ✅ Word (`.docx`) - `mammoth`で抽出

---

## 🐛 トラブルシューティング

### Q: アップロードで「bucket not found」エラー

**A:** Supabase Storageで`documents`バケットを作成してください

### Q: ドキュメントが「処理中」のまま

**A:** サーバーログを確認:
```bash
# ターミナルで開発サーバーのログを確認
# エラーがあればコンソールに表示されます
```

### Q: チャットでドキュメントが参照されない

**A:** 以下を確認:
1. ドキュメントが「処理済み」になっているか
2. 質問がドキュメントの内容と関連しているか

---

## 🎉 完成！

すべてのセットアップが完了しました！

**次のステップ:**
1. SQLを実行
2. Storageバケット作成
3. ドキュメントアップロード
4. チャットで質問

楽しんでください！
